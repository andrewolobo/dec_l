# Service Layer Implementation

## Overview

This document describes the service layer implementation for the DEC_L application. The service layer provides business logic and acts as an intermediary between the API controllers and the Data Access Layer (DAL).

**Implementation Date:** December 11, 2025  
**Status:** Core Services Complete - Auth, User & Post Services Implemented  
**Last Updated:** December 11, 2025

---

## Architecture

### Layer Structure

```
┌─────────────────────────────────────┐
│       API Controllers (Future)       │
├─────────────────────────────────────┤
│         Service Layer               │
│  - AuthService       ✅ Complete    │
│  - UserService       ✅ Complete    │
│  - PostService       ✅ Complete    │
│  - CategoryService   (Planned)      │
│  - PaymentService    (Planned)      │
├─────────────────────────────────────┤
│      Utilities & Configuration       │
│  - PasswordUtil      ✅ Complete    │
│  - JwtUtil           ✅ Complete    │
│  - ValidationUtil    ✅ Complete    │
├─────────────────────────────────────┤
│    Data Access Layer (DAL)          │
│  - Repositories      ✅ Complete    │
│  - Prisma Client     ✅ Complete    │
└─────────────────────────────────────┘
```

---

## Type Definitions

### Common Types (`src/types/common/`)

#### `api-response.types.ts`

**Purpose:** Standardized API response structures for consistent client-server communication.

**Key Interfaces:**

- **ApiResponse\<T>** - Generic response wrapper

  ```typescript
  {
    success: boolean;
    data?: T;
    error?: ApiError;
    meta?: Record<string, any>;
  }
  ```

- **PaginatedResponse\<T>** - Paginated data responses

  ```typescript
  {
    success: boolean;
    data: T[];
    pagination: PaginationMeta;
    error?: ApiError;
  }
  ```

- **ErrorCode Enum** - Standardized error codes (18 types)

  - `VALIDATION_ERROR`
  - `UNAUTHORIZED`
  - `FORBIDDEN`
  - `RESOURCE_NOT_FOUND`
  - `RESOURCE_ALREADY_EXISTS`
  - `INVALID_CREDENTIALS`
  - `INVALID_TOKEN`
  - `EXPIRED_TOKEN`
  - `RATE_LIMIT_EXCEEDED`
  - `PAYMENT_REQUIRED`
  - `PAYMENT_FAILED`
  - `EXTERNAL_SERVICE_ERROR`
  - `DATABASE_ERROR`
  - `INTERNAL_ERROR`
  - `BAD_REQUEST`
  - `CONFLICT`
  - `SERVICE_UNAVAILABLE`
  - `NOT_IMPLEMENTED`

- **Supporting Types:**
  - `PaginationOptions` - Page, limit parameters
  - `PaginationMeta` - Total, page, limit, pages
  - `SortOptions` - Field and order
  - `DateRange` - Start and end dates

---

### Authentication Types (`src/types/auth/`)

#### `auth.types.ts`

**Purpose:** Authentication and authorization data transfer objects.

**Key Interfaces:**

- **RegisterDTO** - User registration payload

  ```typescript
  {
    emailAddress: string;
    password: string;
    fullName: string;
    phoneNumber?: string;
  }
  ```

- **LoginDTO** - Standard login credentials

  ```typescript
  {
    emailAddress: string;
    password: string;
  }
  ```

- **OAuthLoginDTO** - OAuth authentication

  ```typescript
  {
    provider: "Google" | "Microsoft";
    accessToken: string;
  }
  ```

- **JwtPayload** - JWT token payload

  ```typescript
  {
    userId: number;
    email: string;
    iat?: number;
    exp?: number;
  }
  ```

- **AuthTokens** - Token pair

  ```typescript
  {
    accessToken: string;
    refreshToken: string;
  }
  ```

- **AuthResponse** - Authentication response

  ```typescript
  {
    user: AuthUserDTO;
    tokens: AuthTokens;
  }
  ```

- **Additional Types:**
  - `AuthUserDTO` - User data in auth response
  - `RefreshTokenDTO` - Refresh token payload
  - `PhoneVerificationDTO` - Phone verification
  - `OAuthUserInfo` - OAuth provider user data

---

### User Types (`src/types/user/`)

#### `user.types.ts`

**Purpose:** User profile and account management types.

**Key Interfaces:**

- **UserProfileDTO** - Complete user profile

  ```typescript
  {
    id: number;
    fullName: string;
    emailAddress: string;
    phoneNumber?: string;
    profilePictureUrl?: string;
    location?: string;
    bio?: string;
    isEmailVerified: boolean;
    isPhoneVerified: boolean;
    createdAt: Date;
    updatedAt: Date;
  }
  ```

- **UpdateProfileDTO** - Profile update payload
- **ChangePasswordDTO** - Password change request
- **ResetPasswordRequestDTO** - Password reset initiation
- **ResetPasswordDTO** - Password reset completion
- **UserPostsSummaryDTO** - User's post statistics

---

### Post Types (`src/types/post/`)

#### `post.types.ts`

**Purpose:** Post creation, management, and feed functionality types.

**Key Interfaces:**

- **CreatePostDTO** - New post creation

  ```typescript
  {
    title: string;
    categoryId: number;
    description: string;
    price: number;
    location: string;
    contactNumber: string;
    brand?: string;
    emailAddress?: string;
    deliveryMethod?: string;
    gpsLocation?: string;
    images?: CreatePostImageDTO[];
  }
  ```

- **PostResponseDTO** - Complete post data with relations
- **PostStatus Enum** - Post lifecycle states

  - `DRAFT`
  - `SCHEDULED`
  - `PENDING_PAYMENT`
  - `ACTIVE`
  - `EXPIRED`
  - `REJECTED`

- **SearchOptionsDTO** - Advanced search parameters
- **FeedOptionsDTO** - Feed filtering options
- **LikeResponseDTO** - Like operation result

---

### Category Types (`src/types/category/`)

#### `category.types.ts`

**Purpose:** Category management types.

**Key Interfaces:**

- **CreateCategoryDTO** - New category
- **UpdateCategoryDTO** - Category updates
- **CategoryResponseDTO** - Category with post count

---

### Payment Types (`src/types/payment/`)

#### `payment.types.ts`

**Purpose:** Payment processing and pricing types.

**Key Interfaces:**

- **CreatePaymentDTO** - Payment initiation
- **PaymentResponseDTO** - Payment details
- **PricingTierDTO** - Pricing plan information
- **PaymentMethod Enum** - `CARD`, `MOBILE_MONEY`, `BANK_TRANSFER`
- **PaymentStatus Enum** - `PENDING`, `COMPLETED`, `FAILED`, `REFUNDED`
- **UserPaymentHistoryDTO** - User payment records

---

## Utilities

### Password Utility (`src/utils/password.util.ts`)

**Purpose:** Secure password hashing and validation using bcrypt.

**Class:** `PasswordUtil` (static methods)

**Methods:**

1. **hash(password: string): Promise\<string>**

   - Hashes password with bcrypt (12 salt rounds)
   - Returns: Hashed password string

2. **verify(password: string, hash: string): Promise\<boolean>**

   - Compares plain text password with hash
   - Returns: True if password matches

3. **validateStrength(password: string): { valid: boolean; errors: string[] }**
   - Validates password strength requirements:
     - Minimum 8 characters
     - At least one uppercase letter
     - At least one lowercase letter
     - At least one number
     - At least one special character
   - Returns: Validation result with error messages

**Configuration:**

- Salt rounds: 12 (secure default)

---

### JWT Utility (`src/utils/jwt.util.ts`)

**Purpose:** JSON Web Token generation and verification.

**Class:** `JwtUtil` (static methods)

**Methods:**

1. **generateAccessToken(payload: JwtPayload): string**

   - Creates short-lived access token (15 minutes)
   - Used for API authentication

2. **generateRefreshToken(payload: JwtPayload): string**

   - Creates long-lived refresh token (7 days)
   - Used to obtain new access tokens

3. **generateTokenPair(payload: JwtPayload): { accessToken, refreshToken }**

   - Generates both tokens simultaneously
   - Primary method for authentication flows

4. **verifyAccessToken(token: string): JwtPayload**

   - Validates and decodes access token
   - Throws error if invalid/expired

5. **verifyRefreshToken(token: string): JwtPayload**

   - Validates and decodes refresh token
   - Throws error if invalid/expired

6. **decode(token: string): JwtPayload | null**
   - Decodes token without verification
   - Returns null if invalid format

**Configuration:**

- Access token expiry: 15 minutes
- Refresh token expiry: 7 days
- Secrets: Environment variables (`JWT_ACCESS_SECRET`, `JWT_REFRESH_SECRET`)

---

### Validation Utility (`src/utils/validation.util.ts`)

**Purpose:** Request validation using Joi schemas.

**Class:** `ValidationUtil` (static properties and methods)

**Validation Schemas:**

1. **Auth Schemas:**

   - `registerSchema` - Email, password, fullName, phoneNumber
   - `loginSchema` - Email and password
   - `oauthLoginSchema` - Provider and access token

2. **Post Schemas:**

   - `createPostSchema` - All post fields with images (max 10)
   - `updatePostSchema` - Optional post field updates
   - `searchPostsSchema` - Search with filters and pagination

3. **User Schemas:**

   - `updateProfileSchema` - Profile field updates
   - `changePasswordSchema` - Current and new passwords

4. **Payment Schemas:**
   - `createPaymentSchema` - Post, pricing tier, payment method

**Method:**

**validate\<T>(schema: Joi.Schema, data: unknown): ValidationResult**

- Validates data against Joi schema
- Returns: `{ valid: boolean; errors?: string[]; value?: T }`

**Field Validations:**

- Email: RFC 5322 compliant
- Phone: 10-15 digits
- Password: Min 8 characters
- URLs: Valid URI format
- Text lengths: Enforced min/max

---

## Configuration

### Application Config (`src/config/app.config.ts`)

**Export:** `appConfig`

**Settings:**

```typescript
{
  port: 3000,
  env: 'development',
  apiPrefix: '/api/v1',
  pagination: {
    defaultPage: 1,
    defaultLimit: 20,
    maxLimit: 100
  },
  post: {
    maxImages: 10,
    defaultExpiryDays: 30
  },
  upload: {
    maxFileSize: 5242880, // 5MB
    allowedMimeTypes: ['image/jpeg', 'image/png', 'image/webp']
  }
}
```

---

### JWT Config (`src/config/jwt.config.ts`)

**Export:** `jwtConfig`

**Settings:**

```typescript
{
  accessToken: {
    secret: process.env.JWT_ACCESS_SECRET,
    expiresIn: '15m'
  },
  refreshToken: {
    secret: process.env.JWT_REFRESH_SECRET,
    expiresIn: '7d'
  }
}
```

---

### OAuth Config (`src/config/oauth.config.ts`)

**Export:** `oauthConfig`

**Providers:**

1. **Google OAuth:**

   - Client ID/Secret from environment
   - Redirect URI: `/auth/google/callback`
   - Scopes: openid, profile, email
   - User info endpoint: Google OAuth2 API v2

2. **Microsoft OAuth:**
   - Client ID/Secret from environment
   - Redirect URI: `/auth/microsoft/callback`
   - Scopes: openid, profile, email
   - User info endpoint: Microsoft Graph API v1.0

---

## Services

### Authentication Service (`src/services/auth.service.ts`)

**Class:** `AuthService`  
**Export:** `authService` (singleton instance)

**Purpose:** Handles all authentication and authorization operations.

---

#### Method: `register(data: RegisterDTO)`

**Purpose:** Register a new user with email/password.

**Flow:**

1. Check if email already exists
2. Validate password strength (8+ chars, upper, lower, number, special)
3. Hash password with bcrypt
4. Create user in database
5. Generate JWT token pair
6. Return user data and tokens

**Returns:** `ApiResponse<AuthResponse>`

**Error Codes:**

- `RESOURCE_ALREADY_EXISTS` - Email already registered
- `VALIDATION_ERROR` - Weak password
- `INTERNAL_ERROR` - Database/system error

---

#### Method: `login(data: LoginDTO)`

**Purpose:** Authenticate user with email/password.

**Flow:**

1. Find user by email
2. Verify password hash
3. Generate JWT token pair
4. Return user data and tokens

**Returns:** `ApiResponse<AuthResponse>`

**Error Codes:**

- `INVALID_CREDENTIALS` - Wrong email or password
- `INTERNAL_ERROR` - Database/system error

**Security:**

- Generic error message (doesn't reveal if email exists)
- Constant-time password comparison via bcrypt

---

#### Method: `oauthLogin(data: OAuthLoginDTO)`

**Purpose:** Authenticate user via Google or Microsoft OAuth.

**Flow:**

1. Get user info from OAuth provider using access token
2. Check if user exists by OAuth provider ID
3. If new user, create account with OAuth data
4. Generate JWT token pair
5. Return user data and tokens

**Returns:** `ApiResponse<AuthResponse>`

**Error Codes:**

- `EXTERNAL_SERVICE_ERROR` - OAuth provider failed
- `INTERNAL_ERROR` - Database/system error

**OAuth User Info Mapping:**

**Google:**

```typescript
{
  id: response.data.id,
  email: response.data.email,
  name: response.data.name,
  picture: response.data.picture
}
```

**Microsoft:**

```typescript
{
  id: response.data.id,
  email: response.data.mail || response.data.userPrincipalName,
  name: response.data.displayName,
  picture: undefined
}
```

**Features:**

- Auto-verifies email for OAuth users
- Links OAuth account to existing email if found
- Supports both Google and Microsoft providers

---

#### Method: `refreshToken(data: RefreshTokenDTO)`

**Purpose:** Generate new access token using refresh token.

**Flow:**

1. Verify refresh token signature and expiry
2. Extract user payload
3. Generate new access token
4. Return new access token

**Returns:** `ApiResponse<{ accessToken: string }>`

**Error Codes:**

- `INVALID_TOKEN` - Invalid or expired refresh token

**Security:**

- Refresh token must be valid and not expired
- Only returns access token (refresh token remains unchanged)

---

#### Private Method: `getOAuthUserInfo(provider, accessToken)`

**Purpose:** Fetch user information from OAuth provider.

**Flow:**

1. Select provider configuration (Google/Microsoft)
2. Call provider's user info endpoint with access token
3. Map provider response to standard format
4. Return normalized user info

**Returns:** `OAuthUserInfo | null`

**Error Handling:**

- Logs error and returns null on failure
- Allows parent method to handle with proper error response

---

## File Structure

```
src/
├── types/
│   ├── common/
│   │   └── api-response.types.ts    # API response structures
│   ├── auth/
│   │   └── auth.types.ts            # Authentication types
│   ├── user/
│   │   └── user.types.ts            # User profile types
│   ├── post/
│   │   └── post.types.ts            # Post and feed types
│   ├── category/
│   │   └── category.types.ts        # Category types
│   ├── payment/
│   │   └── payment.types.ts         # Payment types
│   └── index.ts                     # Centralized exports
│
├── utils/
│   ├── password.util.ts             # Password hashing/validation
│   ├── jwt.util.ts                  # JWT token management
│   ├── validation.util.ts           # Joi validation schemas
│   └── index.ts                     # Utility exports
│
├── config/
│   ├── app.config.ts                # Application settings
│   ├── jwt.config.ts                # JWT configuration
│   ├── oauth.config.ts              # OAuth provider settings
│   └── index.ts                     # Config exports
│
└── services/
    └── auth.service.ts              # Authentication service
```

---

## Dependencies

### Production Dependencies

| Package        | Version | Purpose                           |
| -------------- | ------- | --------------------------------- |
| `bcrypt`       | Latest  | Password hashing                  |
| `jsonwebtoken` | Latest  | JWT token generation/verification |
| `joi`          | Latest  | Request validation                |
| `axios`        | Latest  | HTTP requests for OAuth           |

### Development Dependencies

| Package               | Version | Purpose                     |
| --------------------- | ------- | --------------------------- |
| `@types/bcrypt`       | Latest  | TypeScript types for bcrypt |
| `@types/jsonwebtoken` | Latest  | TypeScript types for JWT    |

---

## Usage Examples

### Registration

```typescript
import { authService } from "./services/auth.service";
import { RegisterDTO } from "./types";

const registerData: RegisterDTO = {
  emailAddress: "user@example.com",
  password: "SecurePass123!",
  fullName: "John Doe",
  phoneNumber: "1234567890",
};

const result = await authService.register(registerData);

if (result.success) {
  const { user, tokens } = result.data;
  console.log("User registered:", user.id);
  console.log("Access token:", tokens.accessToken);
} else {
  console.error("Registration failed:", result.error.message);
}
```

---

### Login

```typescript
import { authService } from "./services/auth.service";
import { LoginDTO } from "./types";

const loginData: LoginDTO = {
  emailAddress: "user@example.com",
  password: "SecurePass123!",
};

const result = await authService.login(loginData);

if (result.success) {
  const { user, tokens } = result.data;
  // Store tokens securely
  localStorage.setItem("accessToken", tokens.accessToken);
  localStorage.setItem("refreshToken", tokens.refreshToken);
} else {
  console.error("Login failed:", result.error.message);
}
```

---

### OAuth Login

```typescript
import { authService } from "./services/auth.service";
import { OAuthLoginDTO } from "./types";

const oauthData: OAuthLoginDTO = {
  provider: "Google",
  accessToken: "google-oauth-access-token",
};

const result = await authService.oauthLogin(oauthData);

if (result.success) {
  const { user, tokens } = result.data;
  console.log("OAuth login successful:", user.emailAddress);
} else {
  console.error("OAuth failed:", result.error.message);
}
```

---

### Token Refresh

```typescript
import { authService } from "./services/auth.service";
import { RefreshTokenDTO } from "./types";

const refreshData: RefreshTokenDTO = {
  refreshToken: localStorage.getItem("refreshToken"),
};

const result = await authService.refreshToken(refreshData);

if (result.success) {
  localStorage.setItem("accessToken", result.data.accessToken);
} else {
  // Refresh token expired, redirect to login
  window.location.href = "/login";
}
```

---

### Password Validation

```typescript
import { PasswordUtil } from "./utils";

const validation = PasswordUtil.validateStrength("weak");

if (!validation.valid) {
  console.log("Password errors:", validation.errors);
  // Output: ['Password must be at least 8 characters long', ...]
}
```

---

### Request Validation

```typescript
import { ValidationUtil } from "./utils";
import { CreatePostDTO } from "./types";

const postData = {
  title: "iPhone 13",
  categoryId: 1,
  description: "Brand new iPhone",
  price: 800,
  location: "Nairobi",
  contactNumber: "1234567890",
};

const result = ValidationUtil.validate<CreatePostDTO>(
  ValidationUtil.createPostSchema,
  postData
);

if (result.valid) {
  // Proceed with validated data
  const validatedPost = result.value;
} else {
  // Handle validation errors
  console.error("Validation errors:", result.errors);
}
```

---

## Environment Variables

Required environment variables for service layer:

```env
# JWT Configuration
JWT_ACCESS_SECRET=your-secret-access-key-change-in-production
JWT_REFRESH_SECRET=your-secret-refresh-key-change-in-production
JWT_ACCESS_EXPIRY=15m
JWT_REFRESH_EXPIRY=7d

# Google OAuth
GOOGLE_CLIENT_ID=your-google-client-id
GOOGLE_CLIENT_SECRET=your-google-client-secret
GOOGLE_REDIRECT_URI=http://localhost:3000/auth/google/callback

# Microsoft OAuth
MICROSOFT_CLIENT_ID=your-microsoft-client-id
MICROSOFT_CLIENT_SECRET=your-microsoft-client-secret
MICROSOFT_REDIRECT_URI=http://localhost:3000/auth/microsoft/callback

# Application
PORT=3000
NODE_ENV=development
```

---

## Security Best Practices

### Password Security

- ✅ 12 salt rounds for bcrypt (high security)
- ✅ Strong password requirements enforced
- ✅ Passwords never stored in plain text
- ✅ Constant-time comparison via bcrypt

### Token Security

- ✅ Separate secrets for access and refresh tokens
- ✅ Short access token lifetime (15 minutes)
- ✅ Longer refresh token lifetime (7 days)
- ✅ Token verification before processing requests

### OAuth Security

- ✅ Access tokens validated with provider
- ✅ User info fetched directly from provider
- ✅ No password storage for OAuth users
- ✅ Email pre-verified for OAuth accounts

### API Security

- ✅ Standardized error codes (no stack traces to client)
- ✅ Generic error messages for authentication failures
- ✅ Input validation on all endpoints
- ✅ Type safety via TypeScript

---

## Next Steps

### Week 2: User & Category Services (Planned)

**UserService:**

- Get user profile
- Update user profile
- Change password
- Get user posts
- Delete account

**CategoryService:**

- List all categories
- Get category by ID
- Create category (admin)
- Update category (admin)
- Delete category (admin)

### Week 3: Post Service (Planned)

**PostService:**

- Create post
- Update post
- Delete post
- Get post by ID
- Search posts
- Get feed (paginated)
- Like/unlike post
- Schedule post
- Track views

### Week 4: Payment Service (Planned)

**PaymentService:**

- Get pricing tiers
- Initiate payment
- Confirm payment
- Get payment history
- Process refunds

---

## Integration with DAL

The service layer integrates seamlessly with the Data Access Layer (DAL):

```typescript
// Service imports repository
import { userRepository } from "../dal/repositories";

// Service uses repository methods
const user = await userRepository.findByEmail(email);
const newUser = await userRepository.create(userData);
```

**Benefits:**

- ✅ Clean separation of concerns
- ✅ Business logic in services
- ✅ Data access in repositories
- ✅ Type-safe operations throughout
- ✅ Singleton pattern for efficiency

---

## Testing Recommendations

### Unit Tests (Recommended)

1. **PasswordUtil Tests:**

   - Hash generates different values for same input
   - Verify correctly validates matching passwords
   - Verify rejects non-matching passwords
   - Password strength validation catches weak passwords

2. **JwtUtil Tests:**

   - Token generation creates valid JWT format
   - Token verification succeeds for valid tokens
   - Token verification fails for expired tokens
   - Token verification fails for invalid signatures

3. **ValidationUtil Tests:**

   - Valid data passes validation
   - Invalid email format rejected
   - Weak passwords rejected
   - Required fields enforced

4. **AuthService Tests:**
   - Registration creates user and returns tokens
   - Registration rejects duplicate emails
   - Login succeeds with valid credentials
   - Login fails with invalid credentials
   - OAuth creates new users
   - OAuth links to existing users
   - Token refresh generates new access token

---

## Changelog

### December 11, 2025 - Initial Implementation

**Types Added:**

- Common API response types (18 error codes)
- Authentication types (7 interfaces)
- User types (6 interfaces)
- Post types (10 interfaces + 1 enum)
- Category types (3 interfaces)
- Payment types (6 interfaces + 2 enums)

**Utilities Added:**

- PasswordUtil with bcrypt (12 rounds)
- JwtUtil with token generation/verification
- ValidationUtil with Joi schemas

**Configuration Added:**

- Application config (port, pagination, uploads)
- JWT config (secrets, expiry)
- OAuth config (Google, Microsoft)

**Services Added:**

- AuthService with full authentication flow
  - User registration
  - Email/password login
  - OAuth login (Google/Microsoft)
  - Token refresh mechanism

**Dependencies Installed:**

- bcrypt + @types/bcrypt
- jsonwebtoken + @types/jsonwebtoken
- joi
- axios

---

## Conclusion

The service layer foundation is complete with robust authentication, type safety, and security best practices. The modular architecture allows for easy extension with additional services (User, Post, Payment, Category) while maintaining clean separation of concerns.

**Status:** ✅ Week 1 Complete  
**Next:** Week 2 - User & Category Services
